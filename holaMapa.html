<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Fausto</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="Build/Cesium/Cesium.js" type="text/javascript"></script>
        <style>
            @import url("Build/Cesium/Widgets/widgets.css");
        </style>
            </head>
    <body>
        <h1>Este es el computador de Fausto</h1>
        <div style="color: green; font-size: large">Quiubo pueblo!!! Media o miedo???</div>
        <div id="cesiumContainer"></div>
        <div id="toolbar"></div>
        <script>
            var visor = new Cesium.Viewer("cesiumContainer");
            
            function agregarGeojson(archivo,zoom) {
                var miDataSource = new Cesium.GeoJsonDataSource();
                var promesa = miDataSource.load(archivo);
                
                promesa.then(function (miDataSource) {
                    visor.dataSources.add(miDataSource);
                    if (zoom==true) {
                        visor.zoomTo(miDataSource);    
                        }
                        var entidades = miDataSource.entities.values;
                        
                        for (var i = 0; i < entidades.length; i++) {
                            var miEntidad=entidades[i];
                            var propietario=miEntidad.properties.propietario;
                            var altura=miEntidad.properties.altura;
                            var color=matrizColores[propietario];
                            if (!color) {
                                color = Cesium.Color.fromRandom({
                                    alpha:1.0
                                });
                                matrizColores[propietario]=color;    
                                }
                                
                                miEntidad.polygon.material = color;
                                miEntidad.polygon.outline = false;
                                
                                var posicion = miEntidad.polygon.hierachy.getValue().positions[0];
                                miEntidad.polygon.height =0;
                                miEntidad.polygon.extrudeHeight = miEntidad.properties.altura; 
                        }    
                }).otherwise(function (error){
                   console.error(error);
                   console.error('No se cumpliÃ³ la promesa');
                });    
            }
            
            var carga = false;
            var pancarta = document.getElementById('toolbar');
            var cartographic = new Cesium.Cartographic();
            
            visor.clock.onTick.addEventListener(function(clock) {
                var miEntidad = visor.selectedEntity;
                if (!Cesium.defined(miEntidad)) {
                    pancarta.style.display = 'none';
                } else {
                    pancarta.style.display = 'block';
                    
                    if(miEntidad.position !== null && miEntidad.position !== undefined){
                    var position = miEntidad.position.getValue(clock.currentTime);
                    Cesium.Ellipsoid.WGS84.cartesianToCartographic(position, cartographic);
                    pancarta.innerHTML =
                        'Longitud: ' + Cesium.Math.toDegrees(cartographic.longitude).toFixed(3) + ' <br/>' +
                        'Latitud: ' + Cesium.Math.toDegrees(cartographic.latitude).toFixed(3) + ' <br/>' +
                        'Altura: ' + (cartographic.height * 0.001) + ' km' + ' <br/>' +
                        'Tiempo Actual: ' + visor.clock.currentTime + '<br>';
                    }
                }
                //Cargar un geoJSON en un momento dado
                if(Cesium.JulianDate.secondsDifference(visor.clock.currentTime,visor.clock.startTime)>13 && carga==false){
                     agregarGeojson('mapF.geojson',false);
                     carga=true;
                }
                
            });
            
            agregarGeojson('mapF.geojson',true);
            
        </script>
    </body>
</html>
